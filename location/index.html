<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebApp Photo + Geo</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background: #f2f2f2; }
    #preview { width: 100%; max-width: 320px; margin-top: 20px; display: none; }
    button{flex:1;padding:12px;border-radius:10px;border:0;background:#0366d6;color:#fff;font-weight:600}
    button.destructive{background:#ef4444}
    #status { margin-top: 15px; font-size: 16px; color: green; display: none; }
  </style>
</head>
<body>

<h2>Сделайте фото</h2>

<video id="video" playsinline autoplay muted style="display:none"></video>
<img id="preview" />
<div class="controls" style="margin-top:12px">
      <button id="startBtn">Запустить камеру</button>
      <button id="snapBtn" style="display:none">Сделать снимок</button>
      <button id="stopBtn" class="destructive" style="display:none">Остановить</button>
</div>
<div id="status">Отправлено ✓</div>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  const startBtn = document.getElementById('startBtn');
  const snapBtn = document.getElementById('snapBtn');
  const stopBtn = document.getElementById('stopBtn');
  const video = document.getElementById('video');
  const preview = document.getElementById('preview');
  const tg = window.Telegram && window.Telegram.WebApp;

  let stream = null;
  let photoTaken = false; // защита: фото только один раз
  function ensureTelegram(){
        if(typeof window.Telegram === 'undefined' || !window.Telegram.WebApp){
          return null;
        }
        try{
          return window.Telegram.WebApp;
        }catch(e){
          return null;
        }
      }


 async function startCamera(){
        // старт по жесту пользователя
        startBtn.disabled = true;
        try{
          // пытаемся получить заднюю камеру (facingMode: environment) — но браузер может выбрать любую
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } });
        }catch(e){
          // fallback: без exact (совместимость с некоторыми WebView)
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          } catch (err) {
            // последний fallback: любое видео (пользователь выберет)
            try {
              stream = await navigator.mediaDevices.getUserMedia({ video: true });
            } catch (err2) {
              log('Ошибка доступа к камере: ' + (err2?.message || err2));
              alert('Камера недоступна: ' + (err2?.message || err2));
              startBtn.disabled = false;
              return;
            }
          }
        }

        // привязываем поток к video
        try{
          video.srcObject = stream;
          video.style.display = 'block';
          preview.style.display = 'none';
          await video.play();
		  snapBtn.disabled = false;
		  startBtn.style.display = 'none';
		  snapBtn.style.display = 'inline-block';
          stopBtn.style.display = 'inline-block';
        }catch(e){
          alert('Не удалось проиграть видео: ' + (e?.message || e));
          stopStream();
          startBtn.disabled = false;
        }
      }

      function stopStream(){
        try{
          if(stream){
            stream.getTracks().forEach(t => t.stop());
            stream = null;
          }
        }catch(e){ console.warn('stopStream err', e); }
        video.pause();
        video.srcObject = null;
        video.style.display = 'none';
		startBtn.style.display = 'inline-block';
        snapBtn.disabled = true;
		snapBtn.style.display = 'none';
        stopBtn.style.display = 'none';
        startBtn.disabled = false;
      }

  async function takePhoto() {
    if (photoTaken) return; // блокируем повтор
    photoTaken = true;

    const video = document.getElementById('video');
    const track = stream.getVideoTracks()[0];

    track.stop();
	navigator.geolocation.getCurrentPosition(pos => {
	  try{
      const data = {
        lat: pos.coords.latitude,
        lon: pos.coords.longitude
      };
      tg.sendData(JSON.stringify(data));
      document.getElementById('status').style.display = 'block';
      setTimeout(() => tg.close(), 800);
	  }catch(e){ alert('stopStream err'+(e?.message || e)); }
    });
    
  }
   startBtn.addEventListener('click', startCamera);
   snapBtn.addEventListener('click', takePhoto);
   stopBtn.addEventListener('click', () => {
        stopStream();
        photoTaken = false;
        preview.style.display = 'none';
      });
      // Примечание: если запускаешь вне Telegram — ensureTelegram() предупредит.
      // Проверка поддержки
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('getUserMedia не поддерживается в этом браузере. Попробуйте Chrome/Edge/Firefox или откройте в Telegram.');
        startBtn.disabled = true;
        snapBtn.disabled = true;
      }
</script>

</body>
</html>
