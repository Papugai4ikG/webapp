<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebApp — Фото + Гео (надежный)</title>
  <style>
    body{font-family:system-ui,Arial; padding:18px; background:#f6f8fb; color:#0b1724}
    h1{font-size:20px;margin:0 0 12px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(10,20,40,0.06);max-width:720px;margin:0 auto}
    video, img{width:100%;max-width:420px;border-radius:8px;display:block;margin:10px 0; background:#000}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{flex:1;padding:12px;border-radius:10px;border:0;background:#0366d6;color:#fff;font-weight:600}
    button.destructive{background:#ef4444}
    #status{margin-top:10px;font-weight:600;color:green;display:none}
    .muted{color:#6b7280;font-size:14px}
    pre{background:#0b1220;color:#e6eef6;padding:10px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h1>Сделайте фото и отправьте геопозицию</h1>
    <div class="muted">Нажмите <b>Запустить камеру</b>, затем <b>Сделать снимок</b>. Не забудьте разрешить доступ к камере и геопозиции.</div>

    <video id="video" playsinline autoplay muted style="display:none"></video>
    <img id="preview" alt="preview" style="display:none" />

    <div class="controls" style="margin-top:12px">
      <button id="startBtn">Запустить камеру</button>
      <button id="snapBtn" disabled>Сделать снимок</button>
      <button id="retryBtn" style="display:none">Сделать снова</button>
      <button id="stopBtn" class="destructive" style="display:none">Остановить</button>
    </div>

    <div id="status">Отправлено ✓</div>
    <div id="log" class="muted" style="margin-top:12px"></div>
  </div>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Безопасно и надёжно: запуск камеры по клику, canvas fallback, ошибки, отправка через Telegram WebApp
    (function(){
      const startBtn = document.getElementById('startBtn');
      const snapBtn = document.getElementById('snapBtn');
      const retryBtn = document.getElementById('retryBtn');
      const stopBtn = document.getElementById('stopBtn');
      const video = document.getElementById('video');
      const preview = document.getElementById('preview');
      const status = document.getElementById('status');
      const logEl = document.getElementById('log');

      let stream = null;
      let photoTaken = false;

      function log(msg){
        console.log(msg);
        logEl.textContent = String(msg);
      }

      function ensureTelegram(){
        if(typeof window.Telegram === 'undefined' || !window.Telegram.WebApp){
          log('Warning: Telegram.WebApp не доступен. Тестирование вне Telegram возможно, но sendData работать не будет.');
          return null;
        }
        try{
          return window.Telegram.WebApp;
        }catch(e){
          log('Telegram init error: ' + e);
          return null;
        }
      }

      async function startCamera(){
        // старт по жесту пользователя
        startBtn.disabled = true;
        log('Запрашиваем доступ к камере...');
        try{
          // пытаемся получить заднюю камеру (facingMode: environment) — но браузер может выбрать любую
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'user' } } });
        }catch(e){
          // fallback: без exact (совместимость с некоторыми WebView)
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
          } catch (err) {
            // последний fallback: любое видео (пользователь выберет)
            try {
              stream = await navigator.mediaDevices.getUserMedia({ video: true });
            } catch (err2) {
              log('Ошибка доступа к камере: ' + (err2?.message || err2));
              alert('Камера недоступна: ' + (err2?.message || err2));
              startBtn.disabled = false;
              return;
            }
          }
        }

        // привязываем поток к video
        try{
          video.srcObject = stream;
          video.style.display = 'block';
          preview.style.display = 'none';
          await video.play();
          log('Камера запущена');
          snapBtn.disabled = false;
          stopBtn.style.display = 'inline-block';
          retryBtn.style.display = 'none';
        }catch(e){
          log('Ошибка при старте видео: ' + (e?.message || e));
          alert('Не удалось проиграть видео: ' + (e?.message || e));
          stopStream();
          startBtn.disabled = false;
        }
      }

      function stopStream(){
        try{
          if(stream){
            stream.getTracks().forEach(t => t.stop());
            stream = null;
          }
        }catch(e){ console.warn('stopStream err', e); }
        video.pause();
        video.srcObject = null;
        video.style.display = 'none';
        snapBtn.disabled = true;
        stopBtn.style.display = 'none';
        startBtn.disabled = false;
        log('Камера остановлена');
      }

      async function takeSnapshot(){
        if(photoTaken) return;
        if(!stream){
          alert('Камера не запущена');
          return;
        }
        photoTaken = true;
        snapBtn.disabled = true;
        log('Делаем снимок...');

        try{
          // canvas fallback (работает везде)
          const canvas = document.createElement('canvas');
          const w = video.videoWidth || 1280;
          const h = video.videoHeight || Math.round(w * 3/4);
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, w, h);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.88); // base64

          // показываем превью
          preview.src = dataUrl;
          preview.style.display = 'block';

          // остановим камеру (не нужно держать поток)
          stopStream();

          // проверим геолокацию
          log('Запрашиваем геопозицию...');
          const sendData = (lat, lon) => {
            const payload = { lat: lat, lon: lon, photo: dataUrl };
            const tg = ensureTelegram();
            if(tg){
              try{
                tg.sendData(JSON.stringify(payload));
                log('Данные отправлены в бота');
              }catch(e){
                log('sendData error: ' + e);
                alert('Ошибка отправки: ' + e);
                console.error(e);
              }
            }else{
              log('Тест: данные (не отправлены в Telegram): ' + JSON.stringify(payload).slice(0,200) + '...');
            }
            status.style.display = 'block';
            retryBtn.style.display = 'inline-block';
            // закрываем WebApp (если есть)
            if(tg && tg.close) {
              setTimeout(()=>{ try{ tg.close(); }catch(e){/*ignore*/ } }, 600);
            }
          };

          // getCurrentPosition с таймаутом и fallback
          if('geolocation' in navigator){
            const geoOptions = { timeout: 8000, maximumAge: 60_000 };
            navigator.geolocation.getCurrentPosition(
              pos => sendData(pos.coords.latitude, pos.coords.longitude),
              err => {
                console.warn('geolocation err', err);
                // отправляем без координат
                sendData(null, null);
              },
              geoOptions
            );
          } else {
            sendData(null, null);
          }

        }catch(err){
          console.error('snapshot error', err);
          alert('Ошибка при создании снимка: ' + (err?.message || err));
          photoTaken = false;
          snapBtn.disabled = false;
        }
      }

      // события
      startBtn.addEventListener('click', startCamera);
      snapBtn.addEventListener('click', takeSnapshot);
      stopBtn.addEventListener('click', () => {
        stopStream();
        photoTaken = false;
        preview.style.display = 'none';
        status.style.display = 'none';
        retryBtn.style.display = 'none';
      });
      retryBtn.addEventListener('click', () => {
        photoTaken = false;
        startCamera();
        preview.style.display = 'none';
        status.style.display = 'none';
      });

      // Примечание: если запускаешь вне Telegram — ensureTelegram() предупредит.
      // Проверка поддержки
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('getUserMedia не поддерживается в этом браузере. Попробуйте Chrome/Edge/Firefox или откройте в Telegram.');
        log('getUserMedia не поддерживается');
        startBtn.disabled = true;
        snapBtn.disabled = true;
      }
    })();
  </script>
</body>
</html>
