<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Scanner WebApp</title>

  <!-- Библиотека сканера QR -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 1rem; 
      background: #f5f5f5;
    }
    #reader { 
      width: 100%; 
      max-width: 480px; 
      margin: 0 auto; 
      background: white; 
      padding: 10px; 
      border-radius: 8px; 
    }
    #result { 
      margin-top: 1rem; 
      word-break: break-all; 
      font-size: 1.1rem;
    }
    button { 
      padding: 0.8rem 1.2rem; 
      font-size: 1rem; 
      margin: 0.2rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #0088cc;
      color: white;
    }
    button:disabled {
      background: #9bb7c9;
      cursor: default;
    }
    .center { text-align:center; }
  </style>
</head>
<body>

  <h2 class="center">Сканер QR-кодов</h2>

  <div id="reader"></div>

  <div class="center" style="margin-top:1rem;">
    <button id="startBtn">Запустить сканирование</button>
    <button id="stopBtn" disabled>Остановить</button>
  </div>

  <div id="result"></div>

  <!-- JS полностью внутри файла -->
  <script>
    const resultDiv = document.getElementById("result");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const readerId = "reader";

    let scanner = null;

    function initTelegramWebApp() {
      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.expand();
      }
    }

    function onScanSuccess(text) {
      resultDiv.innerHTML = "<b>Найдено:</b> " + text;

      if (window.Telegram?.WebApp?.sendData) {
        window.Telegram.WebApp.sendData(
          JSON.stringify({ qr: text, ts: Date.now() })
        );
      } else {
        alert("Результат: " + text + "\n(Открыто вне Telegram)");
      }

      stopScanner();
    }

    function onScanError(err) {
      console.log("Scan error:", err);
    }

    function startScanner() {
      if (|scanner) return;

      scanner = new Html5Qrcode(readerId);
      const config = { fps: 10, qrbox: 250 };

      scanner
        .start({ facingMode: "environment" }, config, onScanSuccess, onScanError)
        .then(() => {
          startBtn.disabled = true;
          stopBtn.disabled = false;
        })
        .catch((err) => {
          console.error("Camera error:", err);
          resultDiv.textContent = "Ошибка доступа к камере: " + err;
        });
    }

    function stopScanner() {
      if (!scanner) return;

      scanner
        .stop()
        .then(() => {
          scanner.clear();
          scanner = null;
          startBtn.disabled = false;
          stopBtn.disabled = true;
        })
        .catch((err) => console.error("Stop error:", err));
    }

    startBtn.onclick = startScanner;
    stopBtn.onclick = stopScanner;

    window.onload = function () {
      initTelegramWebApp();
      if (!window.Telegram.WebApp) {
        resultDiv.textContent =
          "⚠️ Откройте страницу через Telegram WebApp (кнопку в боте).";
      }
    };
  </script>

</body>
</html>
